<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ­Ù„ÛŒÙ„ Ø´Ø¹Ø±</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="./assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="./assets/css/Vazir-Code.css" />
  <style>
    .syllable-display {display: flex;flex-direction: column;}
    .syllable-display *{
      /* margin-top: 20px; */
      font-size: 1.2em;
      white-space: nowrap; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† Ø®Ø· */
      font-family: 'Vazir Code';
      direction: ltr;
      text-align: left;
    }
    .syllable-display e {
      text-align: right;
    }
    .death {
      border-bottom: 2px solid #d7d7d7;
      padding-bottom: 14px;
    }
    .result {
      text-align: right;
    }

    .summarize {
      font-size: 1.2em;
      font-weight: bold;
      font-family: 'Vazir Code';
    }
    .nav-link {
      font-family: system-ui;
      font-size: 22px;
    }
  </style>
</head>
<body style="text-align: center;">
  <!-- Ù‡Ø¯Ø± -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="./index.html">
        <h2 class="mb-0" style="color: var(--primary-color);font-size: larger;">ğŸ“š Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ØªÙ† Ø¨Ø§Ø² Ø±ÛŒØªÙ…ÛŒÚ©</h4>
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="./index.html">ØªØ­Ù„ÛŒÙ„ Ø´Ø¹Ø± <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./list-words.html">Ù„ÛŒØ³Øª Ú©Ù„Ù…Ø§Øª</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./about.html">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
          </li>
        </ul>
      </div>
      <span class="text-muted">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„Ù…Ø§Øª: <span id="totalWords">Û°</span></span>
    </div>
  </nav>
  <div class="container mt-5">
    <h2 class="mb-3">ØªØ­Ù„ÛŒÙ„ Ø´Ø¹Ø±</h2>
    
    <div id="input-container" class="mb-3"></div>
    
    <button class="btn btn-primary mb-3" onclick="addLine()">Ø§ÙØ²ÙˆØ¯Ù† Ù…ØµØ±Ø¹ Ø¬Ø¯ÛŒØ¯</button>
    <div class="summarize">
      ØªØ¹Ø¯Ø§Ø¯ Ù…ØµØ±Ø¹ Ù‡Ø§: <strong class="countLine"></strong>
      -
      ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨ÛŒØ§Øª: <strong class="countCouplet"></strong>
    </div>
    <br/>
    <div class="import-export"><textarea
      onchange="importPoem(event, this)"
      onfocus="saveLast(event, this)"
      style="width: 100%;"
      rows="15"
    ></textarea></div>
    <button class="btn btn-primary mb-3" onclick="exportAllWordToJson()">Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ú©Ù„Ù…Ø§Øª</button>
  </div>

  <script src="./assets/js/word-list-dont-need.js"></script>
  <script src="./assets/js/check-poem.js"></script>
  <script>
    window.lastPoem = '';
    let allWords = {};

    function loadWords() {
      if (wordList && wordListDontNeed) {
        // ØªØ±Ú©ÛŒØ¨ Ø¯Ùˆ Ù„ÛŒØ³Øª
        allWords = {...wordList, ...wordListDontNeed};
        
        document.getElementById('totalWords').textContent = Object.keys(allWords).length;
        console.log(`âœ… ${Object.keys(allWords).length} Ú©Ù„Ù…Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯`);
      }
    }
    
    loadWords();
    
    function addLine() {
      const inputContainer = document.getElementById('input-container');
      const newInput = document.createElement('div');
      newInput.className = 'row death mb-3';
      newInput.innerHTML = `
        <div class="col-8">
          <div class="row">
            <div class="col-12">
              <input
                class="form-control mb-2"
                type="text"
                placeholder="Ù…ØµØ±Ø¹ Ø¬Ø¯ÛŒØ¯"
                enterkeyhint="done"	
                onkeydown="inputEnter(event, this)"
              >
            </div>
          </div>
          <div class="row result-container">
            <div class="col-9 result"></div>
            <div class="col-3 syllable-count"></div>
          </div>
        </div> <!-- Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ -->
        <div class="syllable-display col-4">
          <span></span>
          <e><e>
        </div>
      `;
      inputContainer.appendChild(newInput);
      const allDeath = document.querySelectorAll('.death');
      [...allDeath].forEach((el) => { 
        checkValue(el);
      });
    }

    function inputEnter(event, inputEl) {
      if (event.key === 'Enter' || event.key === 'Tab') {
        const deathEl = inputEl.parentElement.parentElement.parentElement.parentElement; // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² parentElement
        const currentEl = inputEl.parentElement.parentElement.parentElement.parentElement
        if(deathEl.nextElementSibling == null)
        {
          addLine();
        }
        else
        {
          checkValue(deathEl);
        }
        
        currentEl.nextElementSibling.querySelector('input').focus();

        // 
      }
    }

    function checkValue(deathEl)
    {
      const value = deathEl.querySelector('input').value;
      const resultEl = deathEl.querySelector('.result'); // Ø¹Ù†ØµØ± Ù†ØªÛŒØ¬Ù‡
      const syllableCountEl = deathEl.querySelector('.syllable-count'); // Ø¹Ù†ØµØ± ØªØ¹Ø¯Ø§Ø¯ Ø³ÛŒÙ„Ø§Ø¨â€ŒÙ‡Ø§
      const extractSyllables = extractSyllablesAndLettersFromText(value); // ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ø¯Ø± jstest.js ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
      const syllables = extractSyllables['syllables'];
      const verifySyllables = extractSyllables['verifyIndex'];
      // console.log(verifySyllables);
      resultEl.innerText = showSyllables(extractSyllables); // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
      syllableCountEl.innerText = `ØªØ¹Ø¯Ø§Ø¯ Ø³ÛŒÙ„Ø§Ø¨â€ŒÙ‡Ø§: ${syllables.length}`; // Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø³ÛŒÙ„Ø§Ø¨â€ŒÙ‡Ø§
      const shape = syllables.map(syllable => syllable.length === 1 ? 'U' : '-').join(''); // Ù†Ù…Ø§ÛŒØ´ Ø³ÛŒÙ„Ø§Ø¨â€ŒÙ‡Ø§
      deathEl.querySelector('.syllable-display span').innerText = shape;
      // console.log(findCombinations(shape));
      deathEl.querySelector('.syllable-display e').innerText = findCombinations(shape);
      // console.log(syllables, shape);
      exportPoem()
    }

    function showSyllables(extractSyllables)
    {
      return extractSyllables['syllables'].map((element, index) => {
        if(extractSyllables['verifyIndex'].findIndex((index2) => index2 === index) != -1)
        {
          return element += `âˆš`;
        }
        else
        {
          return element;
        }
      }).join(' + ');
    }

    function exportPoem()
    {
      const allDeathEl = document.querySelectorAll('.death');

      const totalLines = allDeathEl.length; // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…ØµØ±Ø¹â€ŒÙ‡Ø§
      const couplets = Math.floor(totalLines / 2); // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨ÛŒØ§Øª

      // Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ Ù…ØµØ±Ø¹â€ŒÙ‡Ø§ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯ØŒ ÛŒÚ© Ø¨ÛŒØª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø§Ø±ÛŒÙ…
      const hasExtraLine = totalLines % 2 !== 0;

      document.querySelector('.countLine').innerText = totalLines;
      document.querySelector('.countCouplet').innerText = hasExtraLine ? couplets + 1 : couplets;
      const allDeath = [...allDeathEl].map((el, i) => { 
        if(i%2 != 0)
        {
          return el.querySelector('input').value + '\n';
        }
        return el.querySelector('input').value;
      });
      const outputEl = document.querySelector('textarea');
      outputEl.value = allDeath.join('\n');
    }

    function exportAllWordToJson() {
      let allDeath = document.querySelectorAll('.death');
      let result = {};
      let deathResult = [...allDeath].forEach((deathEl) => { 
          const value = deathEl.querySelector('input').value;
          const res = extractSyllablesAndLettersFromText(value)['exWordList'];
          result = {...result, ...res};
      });
      

      
      // ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
      const formattedResult = Object.keys(result).map((index) => {
          const value = result[index];
          return `"${index}": [${value.map((item)=> `'${item}'`).join(', ')}]`; // ÙØ±Ù…Øª Ú©Ù„ÛŒØ¯ Ùˆ Ù…Ù‚Ø¯Ø§Ø±
      }).join(',\n  '); // Ù‡Ø± Ø¢ÛŒØªÙ… Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø®Ø· Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ø¯

      const finalOutput = `{ \n  ${formattedResult} \n}`;
      navigator.clipboard.writeText(finalOutput);
  }


    function saveLast(event, inputEl) {
      window.lastPoem = inputEl.value;
    }

    function importPoem(event, inputEl) {
      const deathContainer = document.querySelector('#input-container');
      const poemText = inputEl.value; // Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø´Ø¹Ø±
      if(poemText.length <  window.lastPoem.length) {
        // console.log('yes');
        deathContainer.innerHTML = ''; 
      }
      let lines = poemText.split('\n'); // ØªÙ‚Ø³ÛŒÙ… Ù…ØªÙ† Ø¨Ù‡ Ø®Ø·ÙˆØ·
      lines = lines.filter((line) => line.trim() !== '');
      let allDeath = document.querySelectorAll('.death');
      if(lines.length > allDeath.length)
      {
        linesNeedNumber = lines.length - allDeath.length;
        for (let index = 0; index < linesNeedNumber; index++) {
          addLine();
          
        }
      }
      allDeath = document.querySelectorAll('.death');
      [...allDeath].forEach((el, i) => { 
        if(lines[i] != null)
        {
          // for (let index = 8203; index < 8208; index++) {
          //   lines[i] = lines[i].replaceAll(String.fromCharCode(8203), " ");
          // }
          lines[i] = lines[i].replaceAll(String.fromCharCode(8204), " "); // is work
          
          el.querySelector('input').value = lines[i];
          checkValue(el);
        }
      });
    }
  </script>

  <!-- Bootstrap JS (optional) -->
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->
</body>
</html>
